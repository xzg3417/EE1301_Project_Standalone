<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photon 2 Wi-Fi Tactical Radar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0b1121; color: #e2e8f0; font-family: 'Segoe UI', 'Roboto Mono', monospace; }
        .panel { background-color: #151e32; border: 1px solid #2d3b55; border-radius: 4px; }
        
        /* 科技感按钮 */
        .btn { 
            background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
            border: 1px solid #334155;
            transition: all 0.1s;
        }
        .btn:hover { border-color: #38bdf8; color: #38bdf8; box-shadow: 0 0 10px rgba(56,189,248,0.2); }
        .btn:active { transform: translateY(1px); }
        
        /* 列表项 */
        .list-item { border-left: 2px solid transparent; }
        .list-item:hover { background-color: #1e293b; border-left-color: #64748b; }
        .list-item.active { background-color: #0c4a6e; border-left-color: #38bdf8; }

        /* 滚动条 */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #0b1121; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #334155; }
        
        /* 数据显示格 */
        .data-box { background: #0f172a; border: 1px solid #1e293b; padding: 10px; }
        .data-label { color: #64748b; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 2px; }
        .data-value { color: #e2e8f0; font-family: 'Courier New', monospace; font-weight: bold; }
        .highlight { color: #38bdf8; text-shadow: 0 0 5px rgba(56,189,248,0.4); }

        canvas { background: #000; border: 1px solid #334155; }
    </style>
</head>
<body class="p-4 h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="flex justify-between items-center mb-4 shrink-0">
        <div class="flex items-center gap-3">
            <div class="w-3 h-3 bg-sky-500 rounded-full animate-pulse shadow-[0_0_10px_#0ea5e9]"></div>
            <div>
                <h1 class="text-2xl font-bold tracking-wider text-sky-500">WIFI_TACTICAL_RADAR</h1>
                <p class="text-[10px] text-slate-500 tracking-[0.2em] uppercase">Photon 2 // RTL872x // Turbo Scan</p>
            </div>
        </div>
        <div class="flex gap-2">
            <button id="simBtn" class="btn px-4 py-1 text-xs text-slate-400">DEMO_SIM</button>
            <button id="connectBtn" class="btn px-4 py-1 text-xs text-sky-400 font-bold border-sky-900">CONNECT_SERIAL</button>
        </div>
    </header>

    <!-- Main Grid -->
    <div class="flex-1 grid grid-cols-12 gap-4 overflow-hidden">
        
        <!-- Left: Network List -->
        <div class="col-span-3 panel flex flex-col overflow-hidden">
            <div class="p-3 border-b border-slate-800 flex justify-between items-center bg-slate-900/50">
                <span class="text-xs font-bold text-slate-400">DETECTED SIGNALS</span>
                <button id="scanBtn" class="text-xs text-sky-500 hover:text-white disabled:opacity-50">[ REFRESH ]</button>
            </div>
            <div id="networkList" class="flex-1 overflow-y-auto custom-scroll p-0">
                <div class="p-4 text-center text-xs text-slate-600 font-mono">
                    > SYSTEM IDLE<br>> WAITING FOR LINK
                </div>
            </div>
        </div>

        <!-- Right: Dashboard -->
        <div class="col-span-9 flex flex-col gap-4 overflow-hidden">
            
            <!-- Top: Intel Grid -->
            <div class="grid grid-cols-4 gap-4 h-24 shrink-0">
                <div class="col-span-2 data-box flex flex-col justify-center relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-1 text-[10px] text-slate-700">TARGET_SSID</div>
                    <div id="dispSSID" class="text-2xl text-white font-bold truncate">--</div>
                    <div id="dispStatus" class="text-xs text-slate-500">NO TARGET LOCKED</div>
                </div>
                <div class="data-box flex flex-col justify-center">
                    <div class="data-label">Signal Strength</div>
                    <div class="flex items-baseline gap-2">
                        <span id="dispRSSI" class="text-4xl highlight">--</span>
                        <span class="text-xs text-slate-500">dBm</span>
                    </div>
                </div>
                <div class="data-box flex flex-col justify-center">
                    <div class="data-label">Update Rate</div>
                    <div class="flex items-baseline gap-2">
                        <span id="dispRate" class="text-2xl text-green-400">0</span>
                        <span class="text-xs text-slate-500">Hz</span>
                    </div>
                </div>
            </div>

            <!-- Middle: Technical Details -->
            <div class="grid grid-cols-4 gap-4 shrink-0">
                <div class="data-box">
                    <div class="data-label">BSSID (MAC Address)</div>
                    <div id="dispBSSID" class="data-value text-sky-300 text-sm">--:--:--:--:--:--</div>
                </div>
                <div class="data-box">
                    <div class="data-label">Channel (Frequency)</div>
                    <div id="dispChannel" class="data-value text-yellow-400">CH --</div>
                </div>
                <div class="data-box">
                    <div class="data-label">Security Protocol</div>
                    <div id="dispSec" class="data-value text-purple-400">--</div>
                </div>
                <div class="data-box relative">
                    <div class="data-label">Signal Quality</div>
                    <div class="w-full bg-slate-800 h-2 mt-2 rounded-full overflow-hidden">
                        <div id="qualityBar" class="h-full bg-sky-500 w-0 transition-all duration-100"></div>
                    </div>
                    <div id="qualityText" class="absolute bottom-1 right-2 text-[10px] text-slate-400">0%</div>
                </div>
            </div>

            <!-- Bottom: Real-time Chart -->
            <div class="flex-1 panel relative flex flex-col">
                <div class="absolute top-2 left-2 text-[10px] text-slate-500 z-10">RSSI HISTORY // T-MINUS 10s</div>
                <canvas id="signalChart" class="flex-1 w-full h-full"></canvas>
            </div>

            <!-- Logger -->
            <div class="h-32 panel bg-black font-mono text-xs overflow-y-auto custom-scroll p-2 text-slate-400" id="logConsole">
                <div class="text-sky-600">> TERMINAL READY...</div>
            </div>
        </div>
    </div>

    <script>
        // --- 系统变量 ---
        let port, reader, writer;
        let isConnected = false;
        let isSimulating = false;
        let simInterval, chartInterval;
        let chartData = new Array(300).fill(-120);
        
        // 性能监控
        let lastPacketTime = 0;
        let packetCount = 0;
        let lastRateCheck = 0;

        // 当前追踪信息
        let currentTarget = { ssid: "", channel: 0 };

        // --- DOM 元素 ---
        const els = {
            connect: document.getElementById('connectBtn'),
            scan: document.getElementById('scanBtn'),
            sim: document.getElementById('simBtn'),
            list: document.getElementById('networkList'),
            log: document.getElementById('logConsole'),
            chart: document.getElementById('signalChart'),
            disp: {
                ssid: document.getElementById('dispSSID'),
                status: document.getElementById('dispStatus'),
                rssi: document.getElementById('dispRSSI'),
                rate: document.getElementById('dispRate'),
                bssid: document.getElementById('dispBSSID'),
                channel: document.getElementById('dispChannel'),
                sec: document.getElementById('dispSec'),
                bar: document.getElementById('qualityBar'),
                qual: document.getElementById('qualityText')
            }
        };

        const ctx = els.chart.getContext('2d');
        resizeChart();
        window.addEventListener('resize', resizeChart);

        // --- 核心逻辑 ---

        els.connect.addEventListener('click', async () => {
            if ("serial" in navigator) {
                try {
                    port = await navigator.serial.requestPort();
                    await port.open({ baudRate: 115200 });
                    
                    const textDecoder = new TextDecoderStream();
                    port.readable.pipeTo(textDecoder.writable);
                    reader = textDecoder.readable.getReader();

                    const textEncoder = new TextEncoderStream();
                    textEncoder.readable.pipeTo(port.writable);
                    writer = textEncoder.writable.getWriter();

                    isConnected = true;
                    stopSimulation();
                    log("SYS", "SERIAL LINK ESTABLISHED");
                    els.connect.innerText = "LINK ACTIVE";
                    els.connect.disabled = true;
                    
                    readLoop();
                    sendCommand("SCAN"); // Auto scan on connect

                } catch (err) {
                    log("ERR", err.message);
                }
            } else {
                alert("Browser not supported. Use Chrome/Edge.");
            }
        });

        els.scan.addEventListener('click', () => {
            if (isConnected) sendCommand("SCAN");
            else if (isSimulating) simulateScan();
        });

        els.sim.addEventListener('click', () => {
            if (isSimulating) stopSimulation();
            else startSimulation();
        });

        // --- 数据处理 ---

        async function readLoop() {
            let buffer = "";
            try {
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    buffer += value;
                    let lines = buffer.split("\n");
                    buffer = lines.pop(); 
                    for (let line of lines) processLine(line.trim());
                }
            } catch (err) {
                log("ERR", "LINK LOST: " + err);
                isConnected = false;
            }
        }

        function processLine(line) {
            if (!line) return;

            // 计算刷新率
            packetCount++;
            const now = performance.now();
            if (now - lastRateCheck > 1000) {
                els.disp.rate.innerText = packetCount; // Update Hz display
                packetCount = 0;
                lastRateCheck = now;
            }

            if (line.startsWith("LOG:")) {
                const parts = line.split(":");
                log(parts[1], parts.slice(2).join(":"));
            }
            else if (line.startsWith("LIST:")) {
                // LIST:SSID,RSSI,CHANNEL,BSSID,SECURITY
                const parts = line.substring(5).split(",");
                if (parts.length >= 5) {
                    addNetwork(parts[0], parts[1], parts[2], parts[3], parts[4]);
                }
            }
            else if (line.startsWith("STATUS:SCAN_START")) {
                els.list.innerHTML = "";
                log("SYS", "SCANNING AIRWAVES...");
            }
            else if (line.startsWith("DATA:")) {
                // DATA:RSSI,CHANNEL,BSSID
                const parts = line.substring(5).split(",");
                const rssi = parseInt(parts[0]);
                
                updateDashboard(rssi, parts[1], parts[2]);
            }
        }

        function addNetwork(ssid, rssi, channel, bssid, sec) {
            if (!ssid) return;
            
            const div = document.createElement('div');
            div.className = "list-item p-3 cursor-pointer text-xs border-b border-slate-800";
            div.innerHTML = `
                <div class="flex justify-between mb-1">
                    <span class="font-bold text-slate-200 truncate w-2/3">${ssid}</span>
                    <span class="text-sky-400 font-mono">${rssi} dBm</span>
                </div>
                <div class="flex justify-between text-[10px] text-slate-500 font-mono">
                    <span>CH:${channel}</span>
                    <span>${bssid}</span>
                    <span>${sec}</span>
                </div>
            `;
            
            div.onclick = () => {
                // UI Selection
                document.querySelectorAll('.list-item').forEach(e => e.classList.remove('active'));
                div.classList.add('active');
                
                // Set Target
                currentTarget = { ssid, channel };
                els.disp.ssid.innerText = ssid;
                els.disp.status.innerText = "TRACKING LOCKED // FAST SCAN";
                els.disp.status.className = "text-xs text-green-400 animate-pulse";
                
                // Clear Chart
                chartData.fill(-120);
                
                // Send Command: TRACK:SSID:CHANNEL (关键：把信道发回去加速)
                if (isConnected) {
                    sendCommand(`TRACK:${ssid}:${channel}`);
                } else if (isSimulating) {
                    log("SIM", `Locking onto ${ssid} (CH ${channel})`);
                    clearInterval(simInterval);
                    simInterval = setInterval(simulateTracking, 100); // 10Hz simulation
                }
            };
            
            els.list.appendChild(div);
        }

        function updateDashboard(rssi, channel, bssid) {
            // Update Intel
            els.disp.rssi.innerText = rssi;
            if (channel) els.disp.channel.innerText = "CH " + channel;
            if (bssid) els.disp.bssid.innerText = bssid;

            // Quality Bar
            // -90 is 0%, -30 is 100%
            let qual = Math.max(0, Math.min(100, (rssi + 95) * 1.6));
            els.disp.bar.style.width = qual + "%";
            els.disp.qual.innerText = Math.floor(qual) + "%";
            
            // Color coding
            if (rssi > -50) els.disp.bar.className = "h-full bg-green-500 w-0 transition-all duration-75";
            else if (rssi > -70) els.disp.bar.className = "h-full bg-yellow-400 w-0 transition-all duration-75";
            else els.disp.bar.className = "h-full bg-red-500 w-0 transition-all duration-75";

            // Chart update
            chartData.push(rssi);
            chartData.shift();
            drawChart();
        }

        // --- 绘图 ---
        function drawChart() {
            const w = els.chart.width;
            const h = els.chart.height;
            
            ctx.fillStyle = "#000";
            ctx.fillRect(0, 0, w, h);
            
            // Grid
            ctx.strokeStyle = "#1e293b";
            ctx.lineWidth = 1;
            ctx.beginPath();
            for (let y = 0; y < h; y += 40) { ctx.moveTo(0, y); ctx.lineTo(w, y); }
            for (let x = 0; x < w; x += 40) { ctx.moveTo(x, 0); ctx.lineTo(x, h); }
            ctx.stroke();

            // Waveform
            ctx.strokeStyle = "#38bdf8";
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            const step = w / (chartData.length - 1);
            for (let i = 0; i < chartData.length; i++) {
                // Map -120..-20 to h..0
                let val = chartData[i];
                if (val < -120) val = -120; 
                const y = h - ((val + 120) / 100 * h);
                
                if (i === 0) ctx.moveTo(0, y);
                else ctx.lineTo(i * step, y);
            }
            ctx.stroke();

            // Gradient Fill
            ctx.lineTo(w, h);
            ctx.lineTo(0, h);
            const grad = ctx.createLinearGradient(0, 0, 0, h);
            grad.addColorStop(0, "rgba(56, 189, 248, 0.2)");
            grad.addColorStop(1, "rgba(56, 189, 248, 0)");
            ctx.fillStyle = grad;
            ctx.fill();
        }

        function resizeChart() {
            els.chart.width = els.chart.parentElement.offsetWidth;
            els.chart.height = els.chart.parentElement.offsetHeight;
        }

        // --- 工具函数 ---
        async function sendCommand(cmd) {
            if (writer) await writer.write(cmd + "\n");
        }

        function log(level, msg) {
            const d = document.createElement('div');
            d.innerText = `[${level}] ${msg}`;
            if (level === "ERR") d.style.color = "#f87171";
            if (level === "SYS") d.style.color = "#94a3b8";
            els.log.appendChild(d);
            els.log.scrollTop = els.log.scrollHeight;
        }

        // --- 模拟逻辑 ---
        function startSimulation() {
            isSimulating = true;
            els.sim.innerText = "STOP SIM";
            els.sim.className = "btn px-4 py-1 text-xs text-green-400 border-green-900";
            simulateScan();
        }
        function stopSimulation() {
            isSimulating = false;
            clearInterval(simInterval);
            els.sim.innerText = "DEMO_SIM";
            els.sim.className = "btn px-4 py-1 text-xs text-slate-400";
        }
        function simulateScan() {
            els.list.innerHTML = "";
            log("SIM", "Generating fake networks...");
            setTimeout(() => {
                addNetwork("Target_Alpha", -55, 6, "AA:BB:CC:11:22:33", "WPA2");
                addNetwork("Neighbor_Net", -82, 11, "11:22:33:44:55:66", "WPA2");
                addNetwork("Coffee_Free", -65, 1, "DD:EE:FF:00:11:22", "OPEN");
            }, 500);
        }
        let simAngle = 0;
        function simulateTracking() {
            simAngle += 0.2;
            const base = -50;
            const noise = (Math.random() - 0.5) * 5;
            const val = base + Math.sin(simAngle) * 30 + noise;
            updateDashboard(Math.floor(val), currentTarget.channel, "AA:BB:CC:11:22:33");
        }

    </script>
</body>
</html>